# 重み付き平均法による日次感情推定

## 概要

重み付き平均法（Weighted Average Method）は、1日の中で記録された複数の感情データから、その日全体の感情を推定する手法です。この手法の特徴は、**時刻が遅いほど重みを大きくする**ことで、1日の終わりに近い感情をより重視する点にあります。

## アルゴリズムの詳細

### 1. 基本的な考え方

人間の感情評価において、「その日どうだったか」を振り返る際、**1日の終わり頃の感情状態の影響が大きい**という仮説に基づいています。例えば、朝は良い気分だったが夕方に嫌なことがあった場合、「今日は悪い日だった」と評価しがちです。

### 2. 重み付け関数

各感情記録に対する重みは、以下の式で計算されます。

#### 時間差の正規化

まず、その日の最初の記録時刻を基準に、各記録の経過時間を計算します。

$$
t_i = \text{記録}_i \text{の時刻} - \text{その日の最初の記録時刻}
$$

これを0～1の範囲に正規化します。

$$
t_{\text{norm}, i} = \frac{t_i - t_{\min}}{t_{\max} - t_{\min}}
$$

ここで、$t_{\min} = 0$（最初の記録）、$t_{\max}$はその日の最後の記録までの経過時間です。

#### 重みの計算

正規化された時間差に線形変換を適用し、重みを算出します。

$$
w_i = t_{\text{norm}, i} \times 1.0 + 0.5
$$

この式により、重みは以下の範囲に収まります。

- **最初の記録（$t_{\text{norm}} = 0$）**: $w = 0.5$
- **最後の記録（$t_{\text{norm}} = 1$）**: $w = 1.5$

つまり、**最後の記録の重みは最初の記録の3倍**になります。

### 3. 重み付き平均の計算

各感情記録のValence値に重みを掛けた加重平均を計算します。

$$
\text{weighted\_avg} = \frac{\sum_{i=1}^{n} w_i \cdot v_i}{\sum_{i=1}^{n} w_i}
$$

ここで、$v_i$はi番目の記録のValence値です。

### 4. 感情カテゴリの判定

計算された重み付き平均値を、以下の閾値で3つのカテゴリに分類します。

- **Negative**: weighted_avg ≤ 4.5
- **Neutral**: 4.5 < weighted_avg ≤ 6.0
- **Positive**: weighted_avg > 6.0

## 実装コード

```python
def algorithm_weighted_average(day_df):
    """重み付き平均法: 時刻が遅いほど重みを大きくした加重平均"""
    if day_df.empty:
        return 'Neutral'
    
    # datetimeでソート
    day_df_sorted = day_df.sort_values('datetime').copy()
    
    # 時間を0-1の範囲に正規化して重みとする
    time_diffs = (day_df_sorted['datetime'] - day_df_sorted['datetime'].min()).dt.total_seconds()
    
    if time_diffs.max() == 0:
        # すべて同じ時刻の場合は通常の平均
        weighted_avg = day_df_sorted['valence'].mean()
    else:
        weights = time_diffs / time_diffs.max()
        # 重みを1以上にする（最小0.5、最大1.5）
        weights = weights * 1.0 + 0.5
        weighted_avg = np.average(day_df_sorted['valence'], weights=weights)
    
    return classify_by_valence(weighted_avg)
```

## 具体例

### 例1: 朝ネガティブ、夕方ポジティブの場合

| 時刻 | Valence | 経過時間（秒） | 正規化時間 | 重み | 重み×Valence |
|------|---------|---------------|-----------|------|-------------|
| 09:00 | 3.0 | 0 | 0.00 | 0.50 | 1.50 |
| 12:00 | 5.0 | 10800 | 0.50 | 1.00 | 5.00 |
| 18:00 | 8.0 | 32400 | 1.00 | 1.50 | 12.00 |

$$
\text{weighted\_avg} = \frac{1.50 + 5.00 + 12.00}{0.50 + 1.00 + 1.50} = \frac{18.50}{3.00} = 6.17
$$

→ **判定: Positive**

通常の平均は $(3.0 + 5.0 + 8.0) / 3 = 5.33$ (Neutral) ですが、重み付き平均では夕方のポジティブな感情が強調され、Positiveと判定されます。

### 例2: 朝ポジティブ、夕方ネガティブの場合

| 時刻 | Valence | 経過時間（秒） | 正規化時間 | 重み | 重み×Valence |
|------|---------|---------------|-----------|------|-------------|
| 09:00 | 8.0 | 0 | 0.00 | 0.50 | 4.00 |
| 12:00 | 5.0 | 10800 | 0.50 | 1.00 | 5.00 |
| 18:00 | 3.0 | 32400 | 1.00 | 1.50 | 4.50 |

$$
\text{weighted\_avg} = \frac{4.00 + 5.00 + 4.50}{0.50 + 1.00 + 1.50} = \frac{13.50}{3.00} = 4.50
$$

→ **判定: Negative**

通常の平均は同じく5.33 (Neutral) ですが、重み付き平均では夕方のネガティブな感情が強調され、Negativeと判定されます。

## 特殊ケースの処理

### 全ての記録が同じ時刻の場合

記録が1件のみ、または全て同時刻の場合、時間差がゼロになります。この場合は重み付けを行わず、通常の算術平均を計算します。

```python
if time_diffs.max() == 0:
    weighted_avg = day_df_sorted['valence'].mean()
```

## 性能評価結果

report.txtによると、重み付き平均法の性能は以下の通りです。

- **1位一致率**: 23.3% (7/30)
- **最悪回避率**: 46.7% (14/30)
- **スコア比率**: 67.6%

他のアルゴリズムと比較すると、一致率は最も低い結果となっています。これは、時間重み付けが必ずしも被験者の主観的評価と一致しないことを示唆しています。

## 利点と欠点

### 利点

1. **時間的文脈の考慮**: 1日の中での感情の変化を時系列的に評価
2. **直感的な仮説**: 「最後の印象が強い」という人間の記憶バイアスをモデル化
3. **実装が簡単**: 線形重み付けのみで実装可能

### 欠点

1. **仮説の妥当性**: 必ずしも全ての人が「最後の感情を重視する」わけではない
2. **一致率の低さ**: 実験結果では他の手法より性能が劣る
3. **個人差の無視**: 個人ごとの時間感覚や記憶パターンの違いを考慮していない

## まとめ

重み付き平均法は、時間的文脈を考慮した感情推定手法として理論的には魅力的ですが、実験結果では期待したほどの性能は得られませんでした。今後の改善として、以下が考えられます。

- 重み関数の非線形化（指数関数的な重み付けなど）
- ユーザーごとの重み係数の学習
- 他の手法とのアンサンブル学習
