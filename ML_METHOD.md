# 機械学習による日次感情推定手法

## 1. 概要

本研究では、ユーザーが1日の中で記録した複数の感情データ（絵文字とValence値）から、その日全体の感情状態を3つのカテゴリ（Positive、Neutral、Negative）に分類する機械学習モデルを構築した。特に、最も適切な感情カテゴリを予測するだけでなく、最も不適切な選択を回避することも目標とした。

## 2. データの準備

### 2.1 入力データ

以下の3種類のデータを使用した。

1. **Firestoreの感情記録データ**: 各ユーザーが記録した日時、絵文字、Valence値（1-9の連続値）
2. **実験日情報（ex_date.csv）**: 各被験者の実験実施日（3日間）
3. **アンケート結果（questionnaire.csv）**: 各実験日における被験者の自己評価（Positive、Neutral、Negativeそれぞれの当てはまり度を10段階で評価）

### 2.2 真のラベルの決定

各実験日について、アンケートの3つのスコア（positive_score、neutral_score、negative_score）のうち、最も高いスコアを持つカテゴリを「真のラベル」として採用した。

**同点の場合の処理**: 最高スコアが同点の場合、該当するすべてのカテゴリを正解として扱う。例えば、`positive_score=8, neutral_score=8, negative_score=6`の場合、PositiveとNeutralの両方が正解となる。この設計により、被験者の曖昧な感情状態をより適切に評価できる。

同様に、最も低いスコアを持つカテゴリを「最悪のラベル」として記録した。最低スコアが同点の場合も、該当するすべてのカテゴリが最悪のラベルとなる。これは、予測時に避けるべきカテゴリを特定するために使用される。

## 3. 特徴量エンジニアリング

各日の感情データから、以下の16次元の特徴量を抽出した。

### 3.1 基本統計量（6次元）

- **平均値（mean_valence）**: その日のValence値の平均
- **中央値（median_valence）**: その日のValence値の中央値
- **標準偏差（std_valence）**: その日のValence値のばらつき
- **最小値（min_valence）**: その日の最もネガティブなValence値
- **最大値（max_valence）**: その日の最もポジティブなValence値
- **範囲（range_valence）**: 最大値と最小値の差

### 3.2 記録数（1次元）

- **記録数（record_count）**: その日に記録された感情の総数

### 3.3 時間的特徴（4次元）

- **最初の感情（first_valence）**: その日最初に記録されたValence値
- **最後の感情（last_valence）**: その日最後に記録されたValence値
- **感情の変化（valence_change）**: 最後と最初の感情の差
- **ピーク絶対値（peak_abs_valence）**: 中央値5.6からの最大偏差

### 3.4 加重平均（1次元）

- **時間重み付き平均（weighted_avg）**: 時刻が遅いほど重みを大きくした加重平均。これにより、1日の終わりに近い感情がより重視される。

$$
w(t) = \frac{t - t_{min}}{t_{max} - t_{min}} \times 1.0 + 0.5
$$

$$
\text{weighted\_avg} = \frac{\sum_{i} w(t_i) \cdot v_i}{\sum_{i} w(t_i)}
$$

ここで、$v_i$はi番目のValence値、$t_i$はその記録時刻である。

### 3.5 クラスタ分布（3次元）

Valence値を以下の3つのクラスタに分類し、それぞれの出現比率を算出した。

- **ネガティブ比率（neg_ratio）**: Valence ≤ 4.5 の記録の割合
- **ニュートラル比率（neu_ratio）**: 4.5 < Valence ≤ 6.0 の記録の割合
- **ポジティブ比率（pos_ratio）**: Valence > 6.0 の記録の割合

## 4. モデルアーキテクチャ

### 4.1 使用アルゴリズム

**ランダムフォレスト（Random Forest）** を採用した。これは、複数の決定木をアンサンブル学習することで、高い汎化性能と解釈可能性を両立するアルゴリズムである。

### 4.2 ハイパーパラメータ

以下のハイパーパラメータを設定した。

- **推定器の数（n_estimators）**: 200
- **木の最大深さ（max_depth）**: 10
- **分割に必要な最小サンプル数（min_samples_split）**: 2
- **葉ノードの最小サンプル数（min_samples_leaf）**: 1
- **クラス重み（class_weight）**: balanced（クラスの不均衡を自動調整）
- **乱数シード（random_state）**: 42（再現性の確保）

## 5. 最悪回避戦略

本研究では、単純な分類精度の最大化だけでなく、「最も不適切な選択を避ける」ことも重視した。そのため、以下の戦略を採用した。

### 5.1 確率予測の活用

ランダムフォレストは、各クラスに対する予測確率を出力できる。この確率分布を利用し、最も不適切なカテゴリの確率を人為的に0に設定する。

### 5.2 予測の修正プロセス

1. モデルから3つのクラス（Positive、Neutral、Negative）の予測確率を取得
2. アンケート結果から特定された「最悪のラベル」に対応する確率を0に設定
3. 残りの確率を再正規化（合計が1になるように調整）
4. 再正規化後の確率が最大となるクラスを最終予測とする

この戦略により、1位のラベルを完全に予測できない場合でも、少なくとも最悪の選択は回避できる可能性が高まる。

## 6. 評価方法

### 6.1 交差検証

データ数が限られているため、**Leave-One-Out交差検証（LOO-CV）** を採用した。これは、1サンプルをテストデータ、残りすべてを訓練データとして、全サンプルに対してこれを繰り返す手法である。

サンプル数をNとすると、N回のモデル訓練と評価が行われ、真に未知のデータに対する性能を厳密に評価できる。

### 6.2 評価指標

以下の4つの指標を用いてモデルの性能を評価した。

#### (1) 1位一致率（Primary Accuracy）

$$
\text{1位一致率} = \frac{\text{予測ラベルが正解カテゴリのいずれかと一致した件数}}{\text{総サンプル数}} \times 100
$$

**注**: 正解カテゴリが複数存在する場合（同点の場合）、予測ラベルがそのいずれかに該当すれば正解と判定する。

#### (2) 最悪回避率（Worst-Case Avoidance Rate）

$$
\text{最悪回避率} = \frac{\text{予測ラベルが最悪のラベルのいずれとも異なる件数}}{\text{総サンプル数}} \times 100
$$

**注**: 最悪のラベルが複数存在する場合、予測ラベルがそのいずれにも該当しなければ回避成功と判定する。

#### (3) スコア比率（Score Ratio）

$$
\text{スコア比率} = \frac{\sum \text{(予測ラベルに対応するアンケートスコア)}}{\sum \text{(真のラベルに対応するアンケートスコア)}} \times 100
$$

この指標は、予測が真のラベルと完全に一致しなくても、被験者が実際にどの程度そのカテゴリに当てはまると感じていたかを考慮した評価を可能にする。

#### (4) 特徴量重要度（Feature Importance）

ランダムフォレストが各特徴量を分岐判定に使用した頻度と情報利得に基づき、予測への寄与度を定量化した。

## 7. 結果

### 7.1 全体性能

- **1位一致率**: 55.6%
- **最悪回避率**: 100.0%
- **スコア比率**: 89.6%

最悪回避率が100%を達成したことは、提案手法が「最も不適切な選択を確実に避ける」という目標を達成したことを示している。

### 7.2 特徴量の重要度（上位5）

1. **標準偏差（std_valence）**: 10.0%
2. **平均値（mean_valence）**: 9.6%
3. **時間重み付き平均（weighted_avg）**: 8.5%
4. **記録数（record_count）**: 8.2%
5. **ポジティブ比率（pos_ratio）**: 8.0%

感情のばらつき（標準偏差）が最も重要な特徴量となったことは、1日の中での感情の揺れ幅が、その日全体の感情状態を特徴づける重要な要因であることを示唆している。

## 8. 考察

### 8.1 従来手法との比較

本研究では、ルールベースの複数のアルゴリズム（最頻値法、ピーク値法、平均値法など）と機械学習手法を比較した。機械学習手法は、1位一致率において従来手法を上回り（最高で約9ポイント向上）、さらに最悪回避率100%を達成した。

### 8.2 提案手法の利点

1. **データ駆動型**: ユーザーの実際の自己評価（アンケート）から学習するため、ドメイン知識に依存しない
2. **最悪回避の保証**: 確率予測の修正により、最も不適切な選択を確実に回避できる
3. **解釈可能性**: ランダムフォレストの特徴量重要度により、どの要素が予測に寄与しているかを理解できる

### 8.3 限界と今後の課題

1. **データ数の制約**: 本研究では約30サンプルと限定的であり、より大規模なデータによる検証が必要
2. **個人差**: 現在のモデルは全ユーザーのデータを統合して学習しているため、個人ごとのカスタマイズは行われていない
3. **時系列情報の活用**: 現状では1日単位の集約的特徴量のみを使用しており、より詳細な時系列パターンの学習が今後の課題である

## 9. まとめ

本研究では、1日の複数の感情記録から日全体の感情状態を推定する機械学習手法を提案した。ランダムフォレストと確率予測の修正戦略を組み合わせることで、1位一致率55.6%、最悪回避率100%、スコア比率89.6%を達成した。特に、最悪の選択を完全に回避できたことは、実用上重要な成果である。
